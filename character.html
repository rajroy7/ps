<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character - Project Skirk</title>
<link rel="icon" href="https://ik.imagekit.io/gukc1okbd/Crystallina_Shape.webp" type="image/webp">
<link rel="stylesheet" href="styles.css">
<style>
.page-title { margin: 18px 0; color: #7c5cff; letter-spacing: 2px; }
/* detail page specific */
.detail-header { display:flex; align-items:center; gap:12px; padding:20px; }
.detail-header .back { color:#ffffff; text-decoration:none; font-size:24px; transition:0.2s; }
.detail-header .back:hover { color:#7c5cff; }
.detail-header .name { font-size:24px; font-weight:700; color:#fff; }
.detail-tabs { display:flex; gap:24px; padding:0 20px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:16px; overflow-x:auto; }
.detail-tabs a { color:#aaa; text-decoration:none; padding:12px 0; transition:color 0.2s; cursor:pointer; white-space:nowrap; }
.detail-tabs a.active { color:#fff; border-bottom:2px solid #7c5cff; }
.character-overview { text-align:center; padding:20px; animation:fadeIn 1s ease; display:flex; flex-direction:column; align-items:center; gap:20px; }
.character-overview img { border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.3); }
.character-overview p { opacity:0.8; margin:0; max-width:600px; font-size:15px; line-height:1.6; }
.info-panels { display:flex; flex-wrap:wrap; gap:20px; padding:0 20px; }
.basic-info, .ascension { background:rgba(255,255,255,0.05); border-radius:12px; padding:20px; flex:1 1 300px; animation:fadeIn 0.8s ease; }
.basic-info table { width:100%; color:#fff; }
.basic-info table td { padding: 8px 0; }
.basic-info table td:first-child { width: 40%; }
.level-config { padding:20px; }
.level-config input[type=range] { width:100%; }
.level-btn { padding:8px 16px; border:1px solid rgba(124,92,255,0.5); background:transparent; color:#fff; border-radius:6px; cursor:pointer; transition:all 0.2s; font-size:14px; font-weight:600; }
.level-btn:hover { border-color:#7c5cff; background:rgba(124,92,255,0.1); }
.level-btn.active { background:#7c5cff; border-color:#7c5cff; color:#fff; }

/* ability cards */
.abilities { display:grid; gap:20px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); padding:20px; }
.ability-card { background:rgba(255,255,255,0.03); border-radius:12px; padding:20px; position:relative; overflow:hidden; transition:transform 0.3s,box-shadow 0.3s; }
.ability-card:hover { transform:translateY(-8px); box-shadow:0 8px 30px rgba(124,92,255,0.2); }
.ability-card h3 { margin-top:0; color:#7c5cff; }
.ability-card p { color:#ddd; line-height:1.4; }
.ability-attrs { margin-top:16px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1); }
.ability-attrs h4 { font-size:12px; color:#aaa; text-transform:uppercase; letter-spacing:1px; margin:0 0 12px 0; }
.ability-attrs table { width:100%; font-size:13px; }
.ability-attrs td { padding:4px 0; color:#ddd; }
.ability-attrs td:last-child { text-align:right; color:#7c5cff; }
@keyframes fadeIn { from{opacity:0} to{opacity:1}} 
.loading { text-align: center; padding: 40px; color: #aaa; }
.error { 
    color: #ff6b6b; 
    padding: 20px; 
    text-align: center; 
    background: rgba(255, 107, 107, 0.1);
    border: 2px solid #ff6b6b;
    border-radius: 8px;
    margin: 20px;
    font-weight: bold;
    white-space: pre-wrap;
    word-break: break-word;
    font-family: monospace;
}
.diffs-container { padding: 20px; }
.diffs-header { margin-bottom: 24px; }
.diffs-header h2 { color: #7c5cff; margin-top: 0; }
.version-selector { background: rgba(124, 92, 255, 0.1); border: 1px solid rgba(124, 92, 255, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
.version-selector h3 { color: #7c5cff; margin-top: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
.version-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; align-items: center; }
.version-btn { padding: 10px 16px; background: rgba(124, 92, 255, 0.2); border: 2px solid rgba(124, 92, 255, 0.3); color: #7c5cff; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 13px; }
.version-btn:hover { background: rgba(124, 92, 255, 0.4); border-color: #7c5cff; }
.version-btn.active { background: #7c5cff; color: #fff; border-color: #7c5cff; }
.comparison-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
.comparison-column { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.1); }
.comparison-column h3 { margin-top: 0; color: #7c5cff; font-size: 14px; }
.comparison-label { background: rgba(124, 92, 255, 0.15); padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; font-size: 12px; color: #aaa; }
.diff-removed { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; padding: 2px 4px; border-radius: 3px; text-decoration: line-through; }
.diff-added { background: rgba(76, 175, 80, 0.2); color: #4caf50; padding: 2px 4px; border-radius: 3px; font-weight: 600; }
.skill-diff-card { 
    background: rgba(255, 255, 255, 0.03); 
    border-radius: 8px; 
    padding: 16px; 
    margin-bottom: 12px; 
    border-left: 3px solid rgba(124, 92, 255, 0.5);
    border: 1px solid rgba(124, 92, 255, 0.2);
}
.skill-diff-card h4 { 
    color: #ddd; 
    margin: 0 0 8px 0; 
    font-size: 13px; 
    font-weight: 600;
}
.skill-diff-card p { 
    margin: 6px 0; 
    font-size: 12px; 
    line-height: 1.6; 
    color: #ccc; 
}
.no-changes { text-align: center; padding: 60px 20px; color: #888; }
.no-changes-icon { font-size: 48px; opacity: 0.5; margin-bottom: 12px; }

</style>
</head>
<body>
<!-- Mobile Sidebar (hidden by default) -->
<div class="sidebar" id="sidebar">
    <ul>
        <li><a href="index.html"><img src="icons/home.png" class="icon"><span class="text">Home</span></a></li>
        <li><a href="characters.html"><img src="icons/characters.png" class="icon"><span class="text">Characters</span></a></li>
        <li><a href="weapons.html"><img src="icons/weapons.png" class="icon"><span class="text">Weapons</span></a></li>
        <li><a href="artifacts.html"><img src="icons/artifacts.png" class="icon"><span class="text">Artifacts</span></a></li>
        <li><a href="achievements.html"><img src="icons/achievements.png" class="icon"><span class="text">Achievements</span></a></li>
        <li><a href="inventory.html"><img src="icons/inventory.png" class="icon"><span class="text">Inventory</span></a></li>
        <li><a href="enemy.html"><img src="icons/enemy.png" class="icon"><span class="text">Enemy Creatures</span></a></li>
        <li><a href="tcg.html"><img src="icons/tcg.png" class="icon"><span class="text">Genius Invokation TCG</span></a></li>
        <li><a href="abyss.html"><img src="icons/abyss.png" class="icon"><span class="text">Spiral Abyss</span></a></li>
        <li><a href="theater.html"><img src="icons/theater.png" class="icon"><span class="text">Imaginarium Theater</span></a></li>
        <li><a href="stygian.html"><img src="icons/stygian.png" class="icon"><span class="text">Stygian Onslaught</span></a></li>
        <li><a href="furnishings.html"><img src="icons/furnishings.png" class="icon"><span class="text">Furnishings</span></a></li>
        <li><a href="furnishing-set.html"><img src="icons/furnishing-set.png" class="icon"><span class="text">Furnishing Set</span></a></li>
        <li><a href="miliastra.html"><img src="icons/miliastra.png" class="icon"><span class="text">Miliastra</span></a></li>
        <li><a href="wonderland.html"><img src="icons/wonderland.png" class="icon"><span class="text">Wonderland</span></a></li>
        <li><a href="mw-set.html"><img src="icons/mw-set.png" class="icon"><span class="text">Miliastra Wonderland Set</span></a></li>
        <li><a href="mw-inventory.html"><img src="icons/mw-inventory.png" class="icon"><span class="text">Miliastra Wonderland Inventory</span></a></li>
        <li><a href="search.html"><img src="icons/search.png" class="icon"><span class="text">Search</span></a></li>
        <li><a href="diff.html"><img src="icons/diff.png" class="icon"><span class="text">Diff</span></a></li>
        <li><a href="wishes.html"><img src="icons/wishes.png" class="icon"><span class="text">Character Wishes</span></a></li>
        <li class="settings-menu-item"><button id="settingsBtn" class="settings-menu-btn"><img src="icons/settings.png" class="icon"><span class="text">Settings</span></button></li>
    </ul>
</div>

<!-- SEARCH MODAL -->
<div id="searchModal" class="search-modal">
  <div class="search-overlay" id="searchOverlay"></div>
  <div class="search-container">
    <div class="search-header">
      <input type="text" id="searchInput" class="search-input" placeholder="Search characters, weapons, artifacts...">
      <button class="search-close" id="searchClose">&times;</button>
    </div>
    <div class="search-results" id="searchResults">
      <p style="text-align: center; color: #999; margin-top: 20px;">Start typing to search...</p>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="settings-section"><h3>Main</h3><div class="settings-row"><label>Language</label><select id="language"><option>English</option><option>French</option><option>German</option><option>Spanish</option><option>Chinese</option><option>Japanese</option></select></div><div class="settings-row"><label>Region</label><select id="region"><option>Europe</option><option>North America</option><option>Asia</option><option>South America</option></select></div><div class="settings-row"><label>Twin</label><select id="twin"><option>Male</option><option>Female</option></select></div></div>
      <div class="settings-section"><h3>Talent</h3><div class="settings-row"><label>Display Style</label><select id="displayStyle"><option>Slider</option><option>Input</option><option>Dropdown</option></select></div><div class="settings-row"><label>Default LVL</label><select id="defaultLvl"><option>1</option><option>5</option><option>10</option><option>15</option><option>20</option></select></div><div class="settings-row"><label>Default LVL (constellation)</label><select id="defaultLvlConstellation"><option>None</option><option>+1</option><option>+2</option><option>+3</option></select></div><div class="settings-row"><label>Default Decimal</label><select id="defaultDecimal"><option>Default</option><option>0</option><option>1</option><option>2</option><option>3</option></select></div><div class="settings-row"><label>Add constellations info</label><input type="checkbox" id="addConstellations"></div></div>
      <div class="settings-section"><h3>Other</h3><div class="settings-row"><label>Unreleased Content</label><select id="unreleased"><option>Disable</option><option>Enable</option></select></div><div class="settings-info"><strong>Note:</strong> Unreleased content includes characters and weapons not yet available.</div></div>
    </div>
    <div class="modal-footer">
        <button id="saveSettingsBtn" class="save-btn">Save</button>
    </div>
  </div>
</div>

<div class="main-content">
  <nav>
    <button class="hamburger" id="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="logo">PROJECT SKIRK</div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="characters.html">Characters</a>
      <a href="weapons.html">Weapons</a>
      <a href="artifacts.html">Artifacts</a>
      <a href="achievements.html">Achievements</a>
      <a href="inventory.html">Inventory</a>
      <button class="nav-search-btn" id="searchBtn" title="Search">
        <img src="icons/search.png" alt="Search" class="search-icon">
      </button>
      <button class="nav-settings-btn" id="topSettingsBtn" title="Settings">
        <img src="icons/settings.png" alt="Settings" class="settings-icon">
      </button>
    </div>
  </nav>

    <div class="detail-header">
        <a href="characters.html" class="back">&larr;</a>
        <span class="name" id="charName">Loading...</span>
    </div>

    <div class="detail-tabs">
        <a data-tab="info" class="active">Character Information</a>
        <a data-tab="stats">Base Stats</a>
        <a data-tab="skills">Skills</a>
        <a data-tab="constellations">Constellations</a>
        <a data-tab="ascension">Ascension</a>
        <a data-tab="diffs">Beta Changes</a>
        <a data-tab="voice">Voice Actors</a>
    </div>

    <div id="content-container">
        <div class="loading">Loading character data...</div>
    </div>
</div>

<footer class="footer">
    <div class="footer-content">
        <h2>PROJECT SKIRK</h2>
        <p class="footer-credit">Created by <strong>Raj Roy</strong></p>
        <p class="footer-memorial">In memory of <strong>homdgcat</strong> and <strong>hakush.in</strong></p>
        <div class="footer-divider"></div>
        <p class="footer-copyright">&copy; 2024 Project Skirk. All rights reserved.</p>
    </div>
</footer>

<script src="script.js"></script>
<script>
// Character map embedded directly in HTML to avoid fetch issues with file:// protocol
const CHAR_MAP_EMBEDDED = {
  "10000002": { "name": "Kamisato Ayaka", "file": "Kamisato Ayaka" },
  "10000003": { "name": "Jean", "file": "Jean" },
  "10000006": { "name": "Lisa", "file": "Lisa" },
  "10000007": { "name": "Traveler", "file": "Traveler" },
  "10000014": { "name": "Barbara", "file": "Barbara" },
  "10000015": { "name": "Kaeya", "file": "Kaeya" },
  "10000016": { "name": "Diluc", "file": "Diluc" },
  "10000020": { "name": "Razor", "file": "Razor" },
  "10000021": { "name": "Amber", "file": "Amber" },
  "10000022": { "name": "Venti", "file": "Venti" },
  "10000023": { "name": "Xiangling", "file": "Xiangling" },
  "10000024": { "name": "Beidou", "file": "Beidou" },
  "10000025": { "name": "Xingqiu", "file": "Xingqiu" },
  "10000026": { "name": "Xiao", "file": "Xiao" },
  "10000027": { "name": "Ningguang", "file": "Ningguang" },
  "10000029": { "name": "Klee", "file": "Klee" },
  "10000030": { "name": "Zhongli", "file": "Zhongli" },
  "10000031": { "name": "Fischl", "file": "Fischl" },
  "10000032": { "name": "Bennett", "file": "Bennett" },
  "10000033": { "name": "Tartaglia", "file": "Tartaglia" },
  "10000034": { "name": "Noelle", "file": "Noelle" },
  "10000035": { "name": "Qiqi", "file": "Qiqi" },
  "10000036": { "name": "Chongyun", "file": "Chongyun" },
  "10000037": { "name": "Ganyu", "file": "Ganyu" },
  "10000038": { "name": "Albedo", "file": "Albedo" },
  "10000039": { "name": "Diona", "file": "Diona" },
  "10000041": { "name": "Mona", "file": "Mona" },
  "10000042": { "name": "Keqing", "file": "Keqing" },
  "10000043": { "name": "Sucrose", "file": "Sucrose" },
  "10000044": { "name": "Xinyan", "file": "Xinyan" },
  "10000045": { "name": "Rosaria", "file": "Rosaria" },
  "10000046": { "name": "Hu Tao", "file": "Hu Tao" },
  "10000047": { "name": "Kaedehara Kazuha", "file": "Kaedehara Kazuha" },
  "10000048": { "name": "Yanfei", "file": "Yanfei" },
  "10000049": { "name": "Yoimiya", "file": "Yoimiya" },
  "10000050": { "name": "Thoma", "file": "Thoma" },
  "10000051": { "name": "Eula", "file": "Eula" },
  "10000052": { "name": "Raiden Shogun", "file": "Raiden Shogun" },
  "10000053": { "name": "Sayu", "file": "Sayu" },
  "10000054": { "name": "Sangonomiya Kokomi", "file": "Sangonomiya Kokomi" },
  "10000055": { "name": "Gorou", "file": "Gorou" },
  "10000056": { "name": "Kujou Sara", "file": "Kujou Sara" },
  "10000057": { "name": "Arataki Itto", "file": "Arataki Itto" },
  "10000058": { "name": "Yae Miko", "file": "Yae Miko" },
  "10000059": { "name": "Shikanoin Heizou", "file": "Shikanoin Heizou" },
  "10000060": { "name": "Yelan", "file": "Yelan" },
  "10000061": { "name": "Kirara", "file": "Kirara" },
  "10000062": { "name": "Aloy", "file": "Aloy" },
  "10000063": { "name": "Shenhe", "file": "Shenhe" },
  "10000064": { "name": "Yun Jin", "file": "Yun Jin" },
  "10000065": { "name": "Kuki Shinobu", "file": "Kuki Shinobu" },
  "10000066": { "name": "Kamisato Ayato", "file": "Kamisato Ayato" },
  "10000067": { "name": "Collei", "file": "Collei" },
  "10000068": { "name": "Dori", "file": "Dori" },
  "10000069": { "name": "Tighnari", "file": "Tighnari" },
  "10000070": { "name": "Nilou", "file": "Nilou" },
  "10000071": { "name": "Cyno", "file": "Cyno" },
  "10000072": { "name": "Candace", "file": "Candace" },
  "10000073": { "name": "Nahida", "file": "Nahida" },
  "10000074": { "name": "Layla", "file": "Layla" },
  "10000075": { "name": "Wanderer", "file": "Wanderer" },
  "10000076": { "name": "Faruzan", "file": "Faruzan" },
  "10000077": { "name": "Yaoyao", "file": "Yaoyao" },
  "10000078": { "name": "Alhaitham", "file": "Alhaitham" },
  "10000079": { "name": "Dehya", "file": "Dehya" },
  "10000080": { "name": "Mika", "file": "Mika" },
  "10000081": { "name": "Kaveh", "file": "Kaveh" },
  "10000082": { "name": "Baizhu", "file": "Baizhu" },
  "10000083": { "name": "Lynette", "file": "Lynette" },
  "10000084": { "name": "Lyney", "file": "Lyney" },
  "10000085": { "name": "Freminet", "file": "Freminet" },
  "10000086": { "name": "Wriothesley", "file": "Wriothesley" },
  "10000087": { "name": "Neuvillette", "file": "Neuvillette" },
  "10000088": { "name": "Charlotte", "file": "Charlotte" },
  "10000089": { "name": "Furina", "file": "Furina" },
  "10000090": { "name": "Chevreuse", "file": "Chevreuse" },
  "10000091": { "name": "Navia", "file": "Navia" },
  "10000092": { "name": "Gaming", "file": "Gaming" },
  "10000093": { "name": "Xianyun", "file": "Xianyun" },
  "10000094": { "name": "Chiori", "file": "Chiori" },
  "10000095": { "name": "Sigewinne", "file": "Sigewinne" },
  "10000096": { "name": "Arlecchino", "file": "Arlecchino" },
  "10000097": { "name": "Sethos", "file": "Sethos" },
  "10000098": { "name": "Clorinde", "file": "Clorinde" },
  "10000099": { "name": "Emilie", "file": "Emilie" },
  "10000100": { "name": "Kachina", "file": "Kachina" },
  "10000101": { "name": "Kinich", "file": "Kinich" },
  "10000102": { "name": "Mualani", "file": "Mualani" },
  "10000103": { "name": "Xilonen", "file": "Xilonen" },
  "10000104": { "name": "Chasca", "file": "Chasca" },
  "10000105": { "name": "Ororon", "file": "Ororon" },
  "10000106": { "name": "Mavuika", "file": "Mavuika" },
  "10000107": { "name": "Citlali", "file": "Citlali" },
  "10000108": { "name": "Lan Yan", "file": "Lan Yan" },
  "10000109": { "name": "Yumemizuki Mizuki", "file": "Yumemizuki Mizuki" },
  "10000110": { "name": "Iansan", "file": "Iansan" },
  "10000111": { "name": "Varesa", "file": "Varesa" },
  "10000112": { "name": "Escoffier", "file": "Escoffier" },
  "10000113": { "name": "Ifa", "file": "Ifa" },
  "10000114": { "name": "Skirk", "file": "Skirk" },
  "10000115": { "name": "Dahlia", "file": "Dahlia" },
  "10000116": { "name": "Ineffa", "file": "Ineffa" },
  "10000117": { "name": "Manekin", "file": "Manekin" },
  "10000118": { "name": "Manekina", "file": "Manekina" },
  "10000119": { "name": "Lauma", "file": "Lauma" },
  "10000120": { "name": "Flins", "file": "Flins" },
  "10000121": { "name": "Aino", "file": "Aino" },
  "10000122": { "name": "Nefer", "file": "Nefer" },
  "10000123": { "name": "Durin", "file": "Durin" },
  "10000124": { "name": "Jahoda", "file": "Jahoda" },
  "10000125": { "name": "Columbina", "file": "Columbina" },
  "10000126": { "name": "Zibai", "file": "Zibai" },
  "10000127": { "name": "Illuga", "file": "Illuga" },
  "10000128": { "name": "Varka", "file": "Varka" },
  "10000130": { "name": "Linnea", "file": "Linnea" }
};

// Character map loaded from embedded data
let characterMap = CHAR_MAP_EMBEDDED;

// Load character map and initialize
async function initPage() {
    try {
        // Debug: Log initialization start
        console.log('Initializing character detail page...');
        console.log('Character map loaded, found', Object.keys(characterMap).length, 'characters');
        
        // Pre-load inventory data
        await loadInventoryData();
        
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id');
        console.log('Looking for character ID:', characterId);
        
        if (!characterId) {
            showError('No character ID specified. Use character?id=10000078');
            return;
        }
        
        if (!characterMap[characterId]) {
            showError(`Character ID ${characterId} not found. Available IDs: ${Object.keys(characterMap).slice(0, 5).join(', ')}...`);
            return;
        }
        
        await loadCharacterData(characterId);
        initDetailPage();
    } catch (error) {
        console.error('Error initializing page:', error);
        showError(`Failed to load character. Error: ${error.message}`);
    }
}

function showError(message) {
    const container = document.getElementById('content-container');
    container.innerHTML = `<div class="error">${message}</div>`;
}

async function loadCharacterData(characterId) {
    try {
        console.log('Loading character data for ID:', characterId);
        
        // Try to load from consolidated characters-data.json first (for GitHub compatibility)
        let charData;
        try {
            const response = await fetch('characters-data.json');
            if (response.ok) {
                const allCharsData = await response.json();
                charData = allCharsData[characterId];
                if (charData) {
                    console.log('Character data loaded from characters-data.json');
                    // Wrap in the expected format
                    charData = charData;
                } else {
                    throw new Error('Character not found in consolidated data');
                }
            } else {
                throw new Error('Consolidated data file not available');
            }
        } catch (consolidatedError) {
            console.log('Trying fallback method from Data/data/ folder:', consolidatedError.message);
            
            // Fallback to individual data files (for local development)
            const charInfo = characterMap[characterId];
            if (!charInfo) {
                throw new Error(`Character ID ${characterId} not found in character map`);
            }
            
            const dataPath = `Data/data/${charInfo.file}.json`;
            console.log('Attempting to fetch from:', dataPath);
            
            const response = await fetch(dataPath);
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error(`Character data file not found. Make sure:\n1. GitHub repository has Data/data/ folder pushed\n2. Or upload characters-data.json to the root directory\n3. Or run locally with HTTP server`);
                }
                throw new Error(`Failed to load ${dataPath}: ${response.status} ${response.statusText}`);
            }
            
            const jsonData = await response.json();
            charData = jsonData.data;
        }
        
        // Update page title
        document.title = `${charData.name} - Project Skirk`;
        document.getElementById('charName').textContent = charData.name;
        console.log('Updated page title to:', charData.name);
        
        // Generate content
        const content = generateCharacterContent(charData);
        document.getElementById('content-container').innerHTML = content;
        console.log('Generated character content');
        
        // Initialize level buttons and material calculator
        initLevelButtons(charData);
        console.log('Initialized level buttons');
        
        // Load and display skills
        displaySkills(charData);
        console.log('Displayed skills');
        
        // Load and display constellations
        displayConstellations(charData);
        console.log('Displayed constellations');
        
        // Load and display stats
        displayStats(charData);
        console.log('Displayed stats');
        
        // Load and display ascension
        displayAscension(charData);
        console.log('Displayed ascension');
        
        // Load and initialize talent calculator
        initTalentCalculator(charData);
        console.log('Initialized talent calculator');
        
        // Load and display voice actors
        displayVoiceActors(charData);
        console.log('Displayed voice actors');
        
        // Load and display diffs
        displayDiffs(charData);
        console.log('Displayed beta changes');
        
    } catch (error) {
        console.error('Error loading character:', error);
        showError(`Failed to load character data:\n${error.message}`);
    }
}

function generateCharacterContent(charData) {
    // Check if icon is a full URL or just a name
    const iconUrl = charData.icon?.startsWith('http') 
        ? charData.icon 
        : `https://gi.yatta.moe/assets/UI/${charData.icon}.png?vh=2024123000`;
    const detail = charData.fetter?.detail || 'No description available';
    const releaseDate = new Date(charData.release * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    
    return `
        <div id="tab-info">
            <div class="character-overview">
                <img src="${iconUrl}" alt="${charData.name}" style="width:240px;height:240px;object-fit:cover;" onerror="this.src='https://via.placeholder.com/240'">
                <p>${detail}</p>
            </div>
            <div class="info-panels">
                <div class="basic-info">
                    <h3>Basic Information</h3>
                    <table>
                        <tr><td>Name</td><td>${charData.name}</td></tr>
                        <tr><td>Title</td><td>${charData.fetter?.title || 'N/A'}</td></tr>
                        <tr><td>Element</td><td>${charData.element ? `<img src="${getElementIcon(mapElementName(charData.element))}" alt="${mapElementName(charData.element)}" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;">${mapElementName(charData.element)}` : 'N/A'}</td></tr>
                        <tr><td>Weapon Type</td><td><img src="${getWeaponIcon(charData.weaponType)}" alt="${formatWeaponType(charData.weaponType)}" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;">${formatWeaponType(charData.weaponType)}</td></tr>
                        <tr><td>Region</td><td>${charData.region || 'N/A'}</td></tr>
                        <tr><td>Rarity</td><td>${charData.rank || 'N/A'}⭐</td></tr>
                        <tr><td>Body Type</td><td>${charData.bodyType || 'N/A'}</td></tr>
                        <tr><td>Birthday</td><td>${formatBirthday(charData.birthday)}</td></tr>
                        <tr><td>Release Date</td><td>${releaseDate}</td></tr>
                    </table>
                </div>
                <div class="ascension">
                    <h3>Constellation Info</h3>
                    <table>
                        <tr><td>Constellation</td><td>${charData.fetter?.constellation || 'N/A'}</td></tr>
                        <tr><td>Native Region</td><td>${charData.fetter?.native || 'N/A'}</td></tr>
                        <tr><td>Special Bonus</td><td>${formatSpecialProp(charData.specialProp)}</td></tr>
                    </table>
                    <h3 style="margin-top:16px;">Base Stats (Lv. 1)</h3>
                    <table>
                        <tr><td>Base HP</td><td>${formatStat(charData.upgrade?.prop)}</td></tr>
                        <tr><td>Base ATK</td><td>${getStatValue(charData.upgrade?.prop, 'FIGHT_PROP_BASE_ATTACK')}</td></tr>
                        <tr><td>Base DEF</td><td>${getStatValue(charData.upgrade?.prop, 'FIGHT_PROP_BASE_DEFENSE')}</td></tr>
                    </table>
                </div>
            </div>
            <div class="level-config">
                <h3>Level Configuration</h3>
                <p style="font-size:14px; color:#aaa; margin-bottom:12px;">Select target level:</p>
                <div id="levelButtons" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;"></div>
                <div id="materialCalculator" style="background: linear-gradient(135deg, rgba(100,100,255,0.05) 0%, rgba(200,150,255,0.05) 100%); border: 1px solid rgba(124,92,255,0.3); border-radius:12px; padding:16px;">
                    <h4 style="margin-top:0; color:#7c5cff;">⚗️ Materials & Mora Required</h4>
                    <div id="materialsDisplay" style="font-size:14px; color:#ddd;"></div>
                </div>

                <!-- Talent Upgrade Calculator -->
                <div id="talentCalculator" style="background: linear-gradient(135deg, rgba(139,90,43,0.05) 0%, rgba(255,200,50,0.05) 100%); border: 1px solid rgba(255,200,50,0.3); border-radius:12px; padding:16px; margin-top:20px;">
                    <h4 style="margin-top:0; color:#ffc107;">⭐ Talent Upgrade Costs</h4>
                    <div id="talentsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 16px;"></div>
                    <div id="talentCostsDisplay" style="font-size:14px; color:#ddd;"></div>
                </div>

                <h4 style="margin-top:20px; color:#7c5cff;">Stats at Selected Level</h4>
                <div id="selectedLevelStats" style="background:rgba(255,255,255,0.05); border-radius:12px; padding:16px;">
                    <table style="width:100%; font-size:14px;">
                        <tr><td style="padding:8px 0;">Base HP</td><td style="color:#7c5cff; text-align:right;" id="statHP">-</td></tr>
                        <tr><td style="padding:8px 0;">Base ATK</td><td style="color:#7c5cff; text-align:right;" id="statATK">-</td></tr>
                        <tr><td style="padding:8px 0;">Base DEF</td><td style="color:#7c5cff; text-align:right;" id="statDEF">-</td></tr>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-skills" style="display:none;">
            <div class="abilities" id="skillsContainer">
                <div class="ability-card">
                    <h3>Skills & Abilities</h3>
                    <p>Loading skills...</p>
                </div>
            </div>
        </div>

        <div id="tab-constellations" style="display:none;">
            <div class="abilities" id="constellationsContainer">
                <div class="ability-card">
                    <h3>Constellations</h3>
                    <p>Loading constellations...</p>
                </div>
            </div>
        </div>

        <div id="tab-ascension" style="display:none;">
            <div id="ascensionContainer" style="padding: 20px;">
                <p>Loading ascension data...</p>
            </div>
        </div>

        <div id="tab-stats" style="display:none;">
            <div id="statsContainer" style="padding: 20px;">
                <p>Loading stats...</p>
            </div>
        </div>

        <div id="tab-diffs" style="display:none;">
            <div id="diffsContainer" style="padding: 20px;">
                <p>Loading beta changes...</p>
            </div>
        </div>

        <div id="tab-voice" style="display:none;">
            <div id="voiceContainer" style="padding: 20px;">
                <p>Loading voice actor data...</p>
            </div>
        </div>
    `;
}

function formatWeaponType(weaponType) {
    const weapons = {
        'WEAPON_SWORD_ONE_HAND': 'Sword',
        'WEAPON_CLAYMORE': 'Claymore',
        'WEAPON_POLEARM': 'Polearm',
        'WEAPON_BOW': 'Bow',
        'WEAPON_CATALYST': 'Catalyst'
    };
    return weapons[weaponType] || weaponType;
}

function formatBirthday(birthday) {
    if (!birthday || !Array.isArray(birthday) || birthday.length < 2) return 'N/A';
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[birthday[0] - 1]} ${birthday[1]}`;
}

function formatSpecialProp(specialProp) {
    const propNames = {
        'FIGHT_PROP_CRITICAL': 'CRIT Rate',
        'FIGHT_PROP_CRITICAL_HURT': 'CRIT DMG',
        'FIGHT_PROP_CHARGE_EFFICIENCY': 'Energy Recharge',
        'FIGHT_PROP_HEAL_ADD': 'Healing Bonus',
        'FIGHT_PROP_ELEMENT_MASTERY': 'Elemental Mastery',
        'FIGHT_PROP_PYRO_ADD_HURT': 'Pyro DMG Bonus',
        'FIGHT_PROP_HYDRO_ADD_HURT': 'Hydro DMG Bonus',
        'FIGHT_PROP_ELECTRO_ADD_HURT': 'Electro DMG Bonus',
        'FIGHT_PROP_CRYO_ADD_HURT': 'Cryo DMG Bonus',
        'FIGHT_PROP_WIND_ADD_HURT': 'Anemo DMG Bonus',
        'FIGHT_PROP_ROCK_ADD_HURT': 'Geo DMG Bonus',
        'FIGHT_PROP_GRASS_ADD_HURT': 'Dendro DMG Bonus',
        'FIGHT_PROP_PHYSICAL_ADD_HURT': 'Physical DMG Bonus'
    };
    return propNames[specialProp] || specialProp || 'N/A';
}

function formatStat(propArray) {
    if (!propArray || !Array.isArray(propArray)) return 'N/A';
    const hp = propArray.find(p => p.propType === 'FIGHT_PROP_BASE_HP');
    return hp ? Math.round(hp.initValue * 100) / 100 : 'N/A';
}

function getStatValue(propArray, propType) {
    if (!propArray || !Array.isArray(propArray)) return 'N/A';
    const prop = propArray.find(p => p.propType === propType);
    return prop ? Math.round(prop.initValue * 100) / 100 : 'N/A';
}

function cleanDescription(text) {
    if (!text) return '';
    // Remove color tags like <color=#FFD780FF>text</color>
    return text.replace(/<color=#[0-9A-Fa-f]{8}FF?>|<\/color>/g, '').replace(/\\n/g, '<br>');
}

function formatTalentDescription(description, params) {
    if (!description || !Array.isArray(params)) return '';
    
    return description.map(desc => {
        if (!desc) return '';
        
        // Replace {paramX:format} with actual values
        return desc.replace(/\{param(\d+):([^}]+)\}/g, (match, paramIdx, format) => {
            const idx = parseInt(paramIdx) - 1;
            if (idx < 0 || idx >= params.length) return match;
            
            const value = params[idx];
            
            // Parse format string
            if (format.includes('F1P')) return (value * 100).toFixed(1) + '%';
            if (format.includes('F1')) return value.toFixed(1);
            if (format.includes('F2P')) return (value * 100).toFixed(2) + '%';
            if (format.includes('F2')) return value.toFixed(2);
            if (format.includes('P')) return (value * 100).toFixed(0) + '%';
            if (format.includes('I')) return Math.round(value).toString();
            return value.toString();
        });
    }).filter(line => line.trim() !== '').join('\n');
}

function displaySkills(charData) {
    const container = document.getElementById('skillsContainer');
    if (!charData.talent) {
        container.innerHTML = '<div class="ability-card"><h3>Skills</h3><p>No skill data available.</p></div>';
        return;
    }
    
    const talents = charData.talent;
    const sortedKeys = Object.keys(talents).sort((a, b) => parseInt(a) - parseInt(b));
    
    // Find talents with promote data (3 main talents) and others
    const mainTalents = [];
    const otherTalents = [];
    const talentTypeNames = ['Normal Attack', 'Elemental Skill', 'Elemental Burst'];
    let typeIndex = 0;
    
    for (let key of sortedKeys) {
        const t = talents[key];
        if (t && t.promote && Object.keys(t.promote).length > 0) {
            mainTalents.push({ key: parseInt(key), data: t, type: talentTypeNames[typeIndex] || `Talent ${key}` });
            typeIndex++;
            if (mainTalents.length >= 3) break;
        }
    }
    
    // Collect remaining talents (passives and others)
    for (let key of sortedKeys) {
        const t = talents[key];
        if (t && (!t.promote || Object.keys(t.promote).length === 0)) {
            otherTalents.push({ key: parseInt(key), data: t });
        }
    }
    
    let html = '';
    
    // Create 3 main talent cards in a row with sliders
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">';
    
    mainTalents.forEach((talentInfo) => {
        const talent = talentInfo.data;
        const key = talentInfo.key;
        const description = cleanDescription(talent.description || '');
        const iconUrl = talent.icon ? `https://gi.yatta.moe/assets/UI/${talent.icon}.png?vh=2024123000` : '';
        const iconImg = iconUrl ? `<img src="${iconUrl}" alt="${talent.name}" style="width:60px; height:60px; border-radius:6px; margin-bottom:8px; border:2px solid #7c5cff;">` : '';
        
        // Get level 10 as default for attributes
        const defaultPromote = talent.promote ? talent.promote['10'] : null;
        let attrsHtml = '';
        
        if (talent.promote && defaultPromote && defaultPromote.description) {
            const formattedAttrs = formatTalentDescription(defaultPromote.description, defaultPromote.params);
            if (formattedAttrs) {
                const attrLines = formattedAttrs.split('\n').map(line => {
                    const parts = line.split('|');
                    if (parts.length === 2) {
                        return `<div style="display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px;"><span>${parts[0]}</span><span style="color: #ffc107; font-weight: 600;">${parts[1]}</span></div>`;
                    }
                    return `<div style="padding: 3px 0; font-size: 11px;">${line}</div>`;
                }).join('');
                
                attrsHtml = `<div class="ability-attrs" style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,200,50,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 6px; flex-wrap: wrap;">
                        <h4 style="color: #ffc107; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Attributes</h4>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="level-display-talent-${key}" style="color: #ffc107; font-weight: 600; font-size: 11px;">Lv.10</span>
                            <input type="range" id="talent-slider-${key}" class="talent-level-slider" min="1" max="10" value="10" style="width: 80px; cursor: pointer;" data-talent-key="${key}">
                        </div>
                    </div>
                    <div id="attrs-content-${key}" style="font-size: 11px; color: #ddd; line-height: 1.4;">
                        ${attrLines}
                    </div>
                </div>`;
            }
        }
        
        html += `
            <div class="ability-card" style="display: flex; flex-direction: column; background: rgba(20,20,40,0.6); border: 1px solid rgba(124,92,255,0.3); border-radius: 8px; padding: 12px;">
                ${iconImg}
                <h3 style="margin: 6px 0; color: #fff; font-size: 13px;">${talent.name || 'Unknown Skill'}</h3>
                <h4 style="margin: 0 0 6px 0; color: #ffc107; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">${talentInfo.type}</h4>
                <p style="color: #ddd; font-size: 12px; line-height: 1.4; margin: 6px 0; flex-grow: 1;">${description}</p>
                ${attrsHtml}
            </div>
        `;
    });
    
    html += '</div>';
    
    // Display other skills (passives) below
    if (otherTalents.length > 0) {
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 16px; border-top: 2px solid rgba(255,200,50,0.2); padding-top: 16px;">';
        
        otherTalents.forEach((talentInfo) => {
            const talent = talentInfo.data;
            const description = cleanDescription(talent.description || '');
            const iconUrl = talent.icon ? `https://gi.yatta.moe/assets/UI/${talent.icon}.png?vh=2024123000` : '';
            const iconImg = iconUrl ? `<img src="${iconUrl}" alt="${talent.name}" style="width:50px; height:50px; border-radius:6px; margin-bottom:8px; border:2px solid rgba(255,200,50,0.3);">` : '';
            
            html += `
                <div class="ability-card" style="background: rgba(40,30,60,0.4); border: 1px solid rgba(255,200,50,0.2); border-radius: 8px; padding: 10px;">
                    ${iconImg}
                    <h3 style="margin: 4px 0; color: #fff; font-size: 12px;">${talent.name || 'Unknown Skill'}</h3>
                    <p style="color: #ccc; font-size: 11px; line-height: 1.3; margin: 0;">${description}</p>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    container.innerHTML = html;
    
    // Add event listeners for each slider
    mainTalents.forEach((talentInfo) => {
        const slider = document.getElementById(`talent-slider-${talentInfo.key}`);
        if (!slider) return;
        
        slider.addEventListener('input', (e) => {
            const selectedLevel = e.target.value;
            const talent = talentInfo.data;
            const displaySpan = document.getElementById(`level-display-talent-${talentInfo.key}`);
            const contentDiv = document.getElementById(`attrs-content-${talentInfo.key}`);
            
            if (displaySpan) displaySpan.textContent = `Lv.${selectedLevel}`;
            
            const promote = talent.promote ? talent.promote[selectedLevel] : null;
            if (promote && promote.description && contentDiv) {
                const formattedAttrs = formatTalentDescription(promote.description, promote.params);
                const attrLines = formattedAttrs.split('\n').map(line => {
                    const parts = line.split('|');
                    if (parts.length === 2) {
                        return `<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05);"><span>${parts[0]}</span><span style="color: #ffc107; font-weight: 600;">${parts[1]}</span></div>`;
                    }
                    return `<div style="padding: 4px 0;">${line}</div>`;
                }).join('');
                contentDiv.innerHTML = attrLines;
            }
        });
    });
}

function displayConstellations(charData) {
    const container = document.getElementById('constellationsContainer');
    if (!charData.constellation) {
        container.innerHTML = '<div class="ability-card"><h3>Constellations</h3><p>No constellation data available.</p></div>';
        return;
    }
    
    let html = '';
    const constellations = charData.constellation;
    const sortedKeys = Object.keys(constellations).sort((a, b) => parseInt(a) - parseInt(b));
    
    sortedKeys.forEach((key, idx) => {
        const const_data = constellations[key];
        if (!const_data) return;
        
        const description = cleanDescription(const_data.description || '');
        const iconUrl = const_data.icon ? `https://gi.yatta.moe/assets/UI/${const_data.icon}.png?vh=2024123000` : '';
        const iconImg = iconUrl ? `<img src="${iconUrl}" alt="${const_data.name}" style="width:80px; height:80px; border-radius:8px; margin-bottom:12px; border:2px solid #7c5cff;">` : '';
        
        html += `
            <div class="ability-card">
                ${iconImg}
                <h3>${idx + 1}. ${const_data.name || 'Unknown'}</h3>
                <p>${description}</p>
            </div>
        `;
    });
    
    container.innerHTML = html || '<div class="ability-card"><h3>Constellations</h3><p>No constellation data available.</p></div>';
}

function displayStats(charData) {
    const container = document.getElementById('statsContainer');
    if (!charData.upgrade || !charData.upgrade.promote) {
        container.innerHTML = '<p>No stats data available.</p>';
        return;
    }
    
    const props = charData.upgrade.prop || [];
    const promotes = charData.upgrade.promote || [];
    const specialProp = charData.specialProp;
    
    let html = '<h2>stat Progression (Level 1 - Level 90)</h2>';
    html += '<table style="width:100%; border-collapse: collapse;"><tr style="background:#7c5cff; color:white;"><th style="padding:10px; text-align:left;">Level</th>';
    
    // Get all unique prop types from all promote levels
    let allProps = {};
    promotes.forEach(p => {
        if (p.addProps) {
            Object.keys(p.addProps).forEach(prop => {
                allProps[prop] = true;
            });
        }
    });
    
    // Add header for each prop
    Object.keys(allProps).forEach(prop => {
        html += `<th style="padding:10px; text-align:left;">${formatPropName(prop)}</th>`;
    });
    html += '</tr>';
    
    // Add base stats row
    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><td style="padding:10px;">Base (Lv. 1)</td>`;
    Object.keys(allProps).forEach(prop => {
        const baseProp = props.find(p => p.propType === prop);
        html += `<td style="padding:10px; color:#7c5cff;">${baseProp ? Math.round(baseProp.initValue) : '-'}</td>`;
    });
    html += '</tr>';
    
    // Add special bonus stat row after base stats
    if (specialProp) {
        const specialPropName = formatPropName(specialProp);
        html += `<tr style="border-bottom: 2px solid rgba(255,200,50,0.3); background: rgba(255,200,50,0.05);"><td style="padding:10px; font-weight:600; color:#ffc107;">⭐ ${specialPropName} (Special)</td>`;
        
        // Get special prop value from base props
        const specialBaseProp = props.find(p => p.propType === specialProp);
        const specialBaseValue = specialBaseProp ? specialBaseProp.initValue : 0;
        
        // For special prop, show it in the first cell and dash for others
        Object.keys(allProps).forEach((prop, idx) => {
            if (prop === specialProp) {
                const isPercentage = specialProp.includes('PERCENT');
                const displayValue = isPercentage ? (specialBaseValue * 100).toFixed(1) + '%' : Math.round(specialBaseValue);
                html += `<td style="padding:10px; color:#ffc107; font-weight:600;">${displayValue}</td>`;
            } else {
                html += `<td style="padding:10px;">-</td>`;
            }
        });
        html += '</tr>';
    }
    
    // Add promote levels
    promotes.forEach((promote, idx) => {
        if (promote.unlockMaxLevel && promote.unlockMaxLevel > 20) {
            html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><td style="padding:10px;">Lv. ${promote.unlockMaxLevel}</td>`;
            Object.keys(allProps).forEach(prop => {
                const addedVal = promote.addProps && promote.addProps[prop];
                const baseProp = props.find(p => p.propType === prop);
                if (baseProp && addedVal) {
                    const total = baseProp.initValue + addedVal;
                    const isPercentage = prop.includes('PERCENT');
                    const displayValue = isPercentage ? (total * 100).toFixed(1) + '%' : Math.round(total);
                    html += `<td style="padding:10px; color:#7c5cff;">${displayValue}</td>`;
                } else {
                    html += `<td style="padding:10px;">-</td>`;
                }
            });
            html += '</tr>';
        }
    });
    
    html += '</table>';
    container.innerHTML = html;
}

function displayAscension(charData) {
    const container = document.getElementById('ascensionContainer');
    if (!charData.upgrade || !charData.upgrade.promote) {
        container.innerHTML = '<p>No ascension data available.</p>';
        return;
    }
    
    const promotes = charData.upgrade.promote || [];
    let html = '<h2>Ascension Requirements</h2>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">';
    
    // Load inventory data for material icons
    fetch('inventory.json')
        .then(r => r.json())
        .then(inventory => {
            promotes.forEach((promote, idx) => {
                if (idx === 0 || !promote.costItems) return;
                
                html += `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(124,92,255,0.2);">
                        <h3 style="color:#7c5cff; margin-top:0;">Ascension ${idx} → Lv. ${promote.unlockMaxLevel}</h3>
                        <table style="width:100%; font-size:14px; margin-bottom: 16px;">
                            <tr><td>Player Level Required:</td><td style="color:#7c5cff;">${promote.requiredPlayerLevel || 'N/A'}</td></tr>
                            <tr><td>Mora Required:</td><td style="color:#ffd700;">${promote.coinCost ? promote.coinCost.toLocaleString() : 'N/A'}</td></tr>
                        </table>
                        <h4 style="margin: 12px 0 12px 0; color:#aaa;">Materials:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px;">
                `;
                
                if (promote.costItems) {
                    Object.entries(promote.costItems).forEach(([itemId, qty]) => {
                        const matIdNum = parseInt(itemId);
                        const invItem = inventory ? inventory.find(item => item.id === matIdNum) : null;
                        
                        if (invItem) {
                            const iconUrl = `https://gi.yatta.moe/assets/UI/${invItem.icon}.png`;
                            const rankColor = ['#888', '#4a9eff', '#00d4ff', '#b291dc', '#ffc107'][invItem.rank - 1] || '#888';
                            
                            html += `
                                <div data-item-id="${matIdNum}" style="display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 6px; background: linear-gradient(135deg, rgba(100,100,255,0.08) 0%, rgba(200,150,255,0.08) 100%); border: 2px solid ${rankColor}; border-radius: 6px; text-align: center; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#ffc107';" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='${rankColor}';">
                                    <img src="${iconUrl}" alt="${invItem.name}" style="width: 40px; height: 40px; object-fit: contain;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect fill=%23333 width=%2240%22 height=%2240%22/%3E%3Ctext fill=%22%23666%22 text-anchor=%22middle%22 x=%2220%22 y=%2228%22 font-size=%2218%22%3E?%3C/text%3E%3C/svg%3E'">
                                    <div style="font-size: 11px; color: #7c5cff; font-weight: 700;">${qty}x</div>
                                    <div style="font-size: 9px; color: #aaa; line-height: 1.2; word-break: break-word; max-width: 80px;">${invItem.name}</div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div data-item-id="${matIdNum}" style="display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 6px; background: linear-gradient(135deg, rgba(100,100,100,0.08) 0%, rgba(150,150,150,0.08) 100%); border: 2px solid #666; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#ffc107';" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#666';">
                                    <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px;">❓</div>
                                    <div style="font-size: 11px; color: #7c5cff; font-weight: 700;">${qty}x</div>
                                    <div style="font-size: 9px; color: #999; line-height: 1.2;">ID: ${itemId}</div>
                                </div>
                            `;
                        }
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        })
        .catch(err => {
            console.warn('Failed to load inventory data:', err);
            // Fallback display without icons
            promotes.forEach((promote, idx) => {
                if (idx === 0 || !promote.costItems) return;
                
                html += `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px;">
                        <h3 style="color:#7c5cff; margin-top:0;">Ascension ${idx} → Lv. ${promote.unlockMaxLevel}</h3>
                        <table style="width:100%; font-size:14px;">
                            <tr><td>Player Level Required:</td><td style="color:#7c5cff;">${promote.requiredPlayerLevel || 'N/A'}</td></tr>
                            <tr><td>Mora Required:</td><td style="color:#ffd700;">${promote.coinCost ? promote.coinCost.toLocaleString() : 'N/A'}</td></tr>
                        </table>
                        <h4 style="margin: 12px 0 8px 0; color:#aaa;">Materials:</h4>
                        <ul style="margin:0; padding-left:20px; font-size:13px;">
                `;
                
                if (promote.costItems) {
                    Object.entries(promote.costItems).forEach(([itemId, count]) => {
                        html += `<li>Item ${itemId}: ${count} required</li>`;
                    });
                }
                
                html += `
                        </ul>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        });
}

function displayVoiceActors(charData) {
    const container = document.getElementById('voiceContainer');
    const cv = charData.fetter?.cv;
    
    if (!cv) {
        container.innerHTML = '<p>No voice actor data available.</p>';
        return;
    }
    
    let html = '<h2>Voice Actors</h2>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
    
    const languages = {
        'EN': 'English',
        'CHS': 'Chinese (Simplified)',
        'JP': 'Japanese',
        'KR': 'Korean'
    };
    
    Object.entries(languages).forEach(([code, langName]) => {
        const voiceActor = cv[code];
        if (voiceActor) {
            html += `
                <div style="background: rgba(124,92,255,0.1); border: 1px solid rgba(124,92,255,0.3); border-radius: 8px; padding: 15px;">
                    <h4 style="margin: 0 0 8px 0; color:#7c5cff;">${langName}</h4>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">${voiceActor}</p>
                </div>
            `;
        }
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayDiffs(charData) {
    const container = document.getElementById('diffsContainer');
    
    // Try to load character changes data
    fetch('character_changes.json')
        .then(response => {
            if (!response.ok) throw new Error('Failed to load character changes');
            return response.json();
        })
        .then(data => {
            const charId = String(charData.id);
            const characterChange = data.characters[charId];
            
            if (!characterChange || characterChange.changed_in_versions.length === 0) {
                container.innerHTML = `
                    <div class="no-changes">
                        <div class="no-changes-icon">✨</div>
                        <h3 style="color: #7c5cff; margin: 12px 0;">No Beta Changes</h3>
                        <p style="margin: 0; opacity: 0.7;">This character had no changes in beta versions.</p>
                    </div>
                `;
                return;
            }
            
            // Sort versions from newest to oldest
            const versions = characterChange.changed_in_versions.sort((a, b) => {
                const aNum = parseFloat(a);
                const bNum = parseFloat(b);
                return bNum - aNum;
            });
            
            // Get patch versions for better granularity
            const patchVersions = characterChange.changed_in_patch_versions || versions.map(v => v + '.0');
            
            let html = '<div class="diffs-container">';
            html += '<div class="diffs-header">';
            html += `<h2>Beta Changes & Balance Updates</h2>`;
            html += `<p style="color: #aaa; margin: 0; font-size: 14px;">Select two patch versions to compare changes made to ${charData.name}</p>`;
            html += '</div>';
            
            // Version selector
            html += '<div class="version-selector">';
            html += '<h3>Compare Patch Versions</h3>';
            html += '<div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 12px; align-items: center;">';
            
            html += '<div>';
            html += '<label for="versionFrom" style="display: block; font-size: 11px; color: #aaa; text-transform: uppercase; margin-bottom: 6px;">From Version</label>';
            html += '<select id="versionFrom" name="versionFrom" class="version-select" autocomplete="off" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(124,92,255,0.3); border-radius: 6px; color: #fff; font-size: 13px;">';
            patchVersions.forEach((v, idx) => {
                html += `<option value="${v}" ${idx === patchVersions.length - 1 ? 'selected' : ''}>${v}</option>`;
            });
            html += '</select>';
            html += '</div>';
            
            html += '<div style="text-align: center; font-size: 18px; color: #7c5cff; font-weight: 700;">→</div>';
            
            html += '<div>';
            html += '<label for="versionTo" style="display: block; font-size: 11px; color: #aaa; text-transform: uppercase; margin-bottom: 6px;">To Version</label>';
            html += '<select id="versionTo" name="versionTo" class="version-select" autocomplete="off" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(124,92,255,0.3); border-radius: 6px; color: #fff; font-size: 13px;">';
            patchVersions.forEach((v, idx) => {
                html += `<option value="${v}" ${idx === 0 ? 'selected' : ''}>${v}</option>`;
            });
            html += '</select>';
            html += '</div>';
            
            html += '</div>';
            html += '<button id="compareBtn" style="margin-top: 16px; padding: 10px 20px; background: linear-gradient(135deg, #7c5cff, #a878ff); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;">Compare Changes</button>';
            html += '</div>';
            
            // Comparison result area
            html += '<div id="comparisonResult" style="display: none; margin-top: 24px;"></div>';
            
            html += '</div>'; // Close diffs-container
            
            container.innerHTML = html;
            
            // Setup comparison button handler
            const compareBtn = document.getElementById('compareBtn');
            const versionFromSelect = document.getElementById('versionFrom');
            const versionToSelect = document.getElementById('versionTo');
            
            compareBtn.addEventListener('click', () => {
                const versionFrom = versionFromSelect.value;
                const versionTo = versionToSelect.value;
                
                console.log('Compare button clicked:', versionFrom, '->', versionTo);
                
                if (versionFrom === versionTo) {
                    alert('Please select two different versions to compare');
                    return;
                }
                
                compareVersions(charData, versionFrom, versionTo);
            });
            
            // Auto-compare when page loads if there are at least 2 versions
            if (patchVersions.length >= 2) {
                setTimeout(() => {
                    console.log('Auto-compare triggered for:', charData.name);
                    compareVersions(charData, patchVersions[patchVersions.length - 1], patchVersions[0]);
                }, 500);
            }
        })
        .catch(error => {
            console.warn('Error loading character changes:', error);
            container.innerHTML = `
                <div class="no-changes">
                    <div class="no-changes-icon">⚠️</div>
                    <h3 style="color: #7c5cff; margin: 12px 0;">Change Data Unavailable</h3>
                    <p style="margin: 0; opacity: 0.7;">Unable to load beta change information at this time.</p>
                </div>
            `;
        });
}

function createTextDiff(oldText, newText) {
    if (!oldText || !newText) return newText;
    
    // Simple word-by-word diff
    const oldWords = oldText.split(/\s+/);
    const newWords = newText.split(/\s+/);
    
    let diffHtml = '';
    let oldIdx = 0, newIdx = 0;
    
    while (oldIdx < oldWords.length || newIdx < newWords.length) {
        if (oldIdx < oldWords.length && newIdx < newWords.length && 
            oldWords[oldIdx] === newWords[newIdx]) {
            // Words match - show normally
            diffHtml += oldWords[oldIdx] + ' ';
            oldIdx++;
            newIdx++;
        } else {
            // Words don't match
            if (oldIdx < oldWords.length) {
                // Show old word as red strikethrough
                diffHtml += `<span style="color: #FF6B6B; text-decoration: line-through;">${oldWords[oldIdx]}</span> `;
                oldIdx++;
            }
            if (newIdx < newWords.length) {
                // Show new word as green
                diffHtml += `<span style="color: #51CF66; font-weight: 600;">${newWords[newIdx]}</span> `;
                newIdx++;
            }
        }
    }
    
    return diffHtml;
}

function compareVersions(charData, versionFrom, versionTo) {
    console.log('compareVersions called:', versionFrom, '->', versionTo);
    console.log('Char ID:', charData.id, 'Type:', typeof charData.id);
    const resultDiv = document.getElementById('comparisonResult');
    
    if (!resultDiv) {
        console.error('comparisonResult div not found!');
        return;
    }
    
    resultDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #7c5cff;">Loading comparison data...</div>';
    resultDiv.style.display = 'block';
    
    // Load diff data if available
    fetch('version_diffs.json')
        .then(response => {
            console.log('version_diffs.json fetched, status:', response.status);
            if (!response.ok) throw new Error('Failed to fetch version_diffs.json');
            return response.json();
        })
        .then(diffData => {
            console.log('Diff data loaded, total keys:', Object.keys(diffData).length);
            console.log('Looking for char ID:', String(charData.id));
            console.log('Char in diffs?', String(charData.id) in diffData);
            displayComparisonResults(charData, versionFrom, versionTo, diffData);
        })
        .catch(error => {
            console.error('Error loading diffs:', error);
            displayComparisonResults(charData, versionFrom, versionTo, {});
        });
}

function cleanDescription(desc) {
    // Remove ALL color codes and LINK tags - make everything white by default
    // Only keep structure, no colors
    return desc
        .replace(/<color=#[A-F0-9]{6}FF>/g, '')
        .replace(/{\/color}/g, '')
        .replace(/{LINK#[^}]+}/g, '')
        .replace(/{\/LINK}/g, '')
        .replace(/\\n\\n/g, '\n\n');
}

function displayComparisonResults(charData, versionFrom, versionTo, diffData) {
    console.log('displayComparisonResults called for:', charData.name, 'charId:', charData.id);
    console.log('Comparing:', versionFrom, '→', versionTo);
    const resultDiv = document.getElementById('comparisonResult');
    
    if (!resultDiv) {
        console.error('comparisonResult div not found!');
        return;
    }
    
    // Ensure the div is visible
    resultDiv.style.display = 'block';
    
    // Convert talent and constellation objects to arrays
    const talentObj = charData.talent || {};
    const constObj = charData.constellation || {};
    
    const talents = Object.keys(talentObj).map(key => talentObj[key]);
    const constellations = Object.keys(constObj).map(key => constObj[key]);
    
    console.log('Talents:', talents.length, 'Constellations:', constellations.length);
    
    let html = '<div style="margin-top: 20px;">';
    html += `<div style="background: rgba(124, 92, 255, 0.1); border-left: 4px solid #7c5cff; padding: 16px; border-radius: 6px; margin-bottom: 20px;">`;
    html += `<h3 style="color: #7c5cff; margin-top: 0; font-size: 14px;">Changes: v${versionFrom} → v${versionTo}</h3>`;
    html += `<p style="margin: 8px 0 0 0; color: #aaa; font-size: 12px;"><span style="color: #FF6B6B; text-decoration: line-through;">Red strikethrough</span> = old text | <span style="color: #51CF66; font-weight: 600;">Green bold</span> = new text</p>`;
    html += `</div>`;
    
    // Get diff info for this character
    const charDiffData = diffData[String(charData.id)] || diffData[charData.id] || {};
    const versionFromDiff = charDiffData.diffs ? charDiffData.diffs[versionFrom] : null;
    const versionToDiff = charDiffData.diffs ? charDiffData.diffs[versionTo] : null;
    
    console.log('Diff data found for:', versionFrom, '?', !!versionFromDiff, 'and', versionTo, '?', !!versionToDiff);
    
    // Display talents/skills with diffs
    if (talents.length > 0) {
        html += '<h4 style="color: #7c5cff; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-top: 24px; margin-bottom: 12px;">Skills & Abilities</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">';
        
        talents.forEach((talent, idx) => {
            if (talent && talent.name && talent.description) {
                let talentName = talent.name || 'Unnamed Talent';
                
                let typeLabel = '';
                if (talent.type === 0) typeLabel = 'Normal Attack';
                else if (talent.type === 1) typeLabel = 'Elemental Skill';
                else if (talent.type === 2) typeLabel = 'Elemental Burst';
                else typeLabel = 'Ability';
                
                // Get old and new text from diffs
                let oldText = '';
                let newText = '';
                let hasChanges = false;
                
                if (versionFromDiff && versionFromDiff.talent && versionFromDiff.talent[idx]) {
                    oldText = cleanDescription(versionFromDiff.talent[idx].new) || cleanDescription(versionFromDiff.talent[idx].old);
                    hasChanges = true;
                } 
                
                if (versionToDiff && versionToDiff.talent && versionToDiff.talent[idx]) {
                    newText = cleanDescription(versionToDiff.talent[idx].new) || cleanDescription(versionToDiff.talent[idx].old);
                    hasChanges = true;
                }
                
                // Create diff
                let diffDesc = talent.description; // Default to current
                if (hasChanges && oldText && newText) {
                    console.log(`Found diffs for talent ${idx}: ${oldText.substring(0,40)}... -> ${newText.substring(0,40)}...`);
                    diffDesc = createTextDiff(oldText, newText);
                } else if (hasChanges && newText) {
                    diffDesc = newText;
                } else if (hasChanges && oldText) {
                    diffDesc = oldText;
                } else {
                    diffDesc = cleanDescription(talent.description);
                }
                
                html += `
                    <div class="skill-diff-card">
                        <h4 style="margin: 0 0 4px 0; color: #FFD780;">${talentName}</h4>
                        <p style="margin: 0 0 12px 0; font-size: 11px; color: #999; text-transform: uppercase;">${typeLabel}</p>
                        <div style="font-size: 12px; line-height: 1.6; color: #fff;">
                            ${diffDesc}
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
    }
    
    // Display constellations with diffs
    if (constellations.length > 0) {
        html += '<h4 style="color: #7c5cff; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-top: 24px; margin-bottom: 12px;">Constellations</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">';
        
        constellations.forEach((constellation, idx) => {
            if (constellation && constellation.name && constellation.description) {
                let constName = constellation.name || `Constellation ${idx + 1}`;
                
                let oldText = '';
                let newText = '';
                let hasChanges = false;
                
                if (versionFromDiff && versionFromDiff.constellation && versionFromDiff.constellation[idx]) {
                    oldText = cleanDescription(versionFromDiff.constellation[idx].new) || cleanDescription(versionFromDiff.constellation[idx].old);
                    hasChanges = true;
                }
                
                if (versionToDiff && versionToDiff.constellation && versionToDiff.constellation[idx]) {
                    newText = cleanDescription(versionToDiff.constellation[idx].new) || cleanDescription(versionToDiff.constellation[idx].old);
                    hasChanges = true;
                }
                
                let diffDesc = constellation.description;
                if (hasChanges && oldText && newText) {
                    diffDesc = createTextDiff(oldText, newText);
                } else if (hasChanges && newText) {
                    diffDesc = newText;
                } else if (hasChanges && oldText) {
                    diffDesc = oldText;
                } else {
                    diffDesc = cleanDescription(constellation.description);
                }
                
                html += `
                    <div class="skill-diff-card">
                        <h4 style="margin: 0 0 8px 0; color: #FFD780;">C${idx + 1} - ${constName}</h4>
                        <div style="font-size: 12px; line-height: 1.6; color: #fff;">
                            ${diffDesc}
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
    }
    
    if (talents.length === 0 && constellations.length === 0) {
        html += `
            <div style="background: rgba(124, 92, 255, 0.1); border: 1px solid rgba(124, 92, 255, 0.3); border-radius: 8px; padding: 20px; text-align: center; color: #aaa; margin-top: 20px;">
                <p style="margin: 0 0 8px 0; font-size: 14px;">No skill or constellation data available</p>
                <p style="font-size: 12px; margin: 0; opacity: 0.7;">Unable to load character ability data.</p>
            </div>
        `;
    }
    
    // Add comparison info footer
    html += `
        <div style="margin-top: 24px; padding: 16px; background: rgba(255, 200, 50, 0.08); border-left: 4px solid #ffc107; border-radius: 6px;">
            <h4 style="color: #ffc107; margin-top: 0; font-size: 12px; text-transform: uppercase;">About This Comparison</h4>
            <p style="color: #aaa; font-size: 12px; margin: 0; line-height: 1.6;">
                Showing changes from v${versionFrom} to v${versionTo}. ${versionToDiff ? 'Diffs applied.' : 'Using current ability descriptions.'}
            </p>
        </div>
    `;
    
    html += '</div>';
    
    console.log('Setting resultDiv.innerHTML, HTML length:', html.length);
    resultDiv.innerHTML = html;
    console.log('HTML content set to resultDiv');
    
    // Scroll to results
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function computeTextDiff(oldText, newText) {
    // Simple diff highlighting - can be enhanced with a proper diff library
    const oldWords = oldText.split(' ');
    const newWords = newText.split(' ');
    
    let diffHtml = '';
    let oldIdx = 0, newIdx = 0;
    
    while (oldIdx < oldWords.length || newIdx < newWords.length) {
        if (oldIdx < oldWords.length && newIdx < newWords.length && oldWords[oldIdx] === newWords[newIdx]) {
            diffHtml += oldWords[oldIdx] + ' ';
            oldIdx++;
            newIdx++;
        } else {
            if (oldIdx < oldWords.length) {
                diffHtml += `<span class="diff-removed">${oldWords[oldIdx]}</span> `;
                oldIdx++;
            }
            if (newIdx < newWords.length) {
                diffHtml += `<span class="diff-added">${newWords[newIdx]}</span> `;
                newIdx++;
            }
        }
    }
    
    return diffHtml;
}

function formatPropName(propType) {
    const propNames = {
        'FIGHT_PROP_BASE_HP': 'HP',
        'FIGHT_PROP_BASE_ATTACK': 'ATK',
        'FIGHT_PROP_BASE_DEFENSE': 'DEF',
        'FIGHT_PROP_CRITICAL': 'CRIT Rate',
        'FIGHT_PROP_CRITICAL_HURT': 'CRIT DMG',
        'FIGHT_PROP_CHARGE_EFFICIENCY': 'Energy Recharge',
        'FIGHT_PROP_HEAL_ADD': 'Healing Bonus',
        'FIGHT_PROP_ELEMENT_MASTERY': 'Elemental Mastery',
        'FIGHT_PROP_PYRO_ADD_HURT': 'Pyro Bonus',
        'FIGHT_PROP_HYDRO_ADD_HURT': 'Hydro Bonus',
        'FIGHT_PROP_ELECTRO_ADD_HURT': 'Electro Bonus',
        'FIGHT_PROP_CRYO_ADD_HURT': 'Cryo Bonus',
        'FIGHT_PROP_WIND_ADD_HURT': 'Anemo Bonus',
        'FIGHT_PROP_ROCK_ADD_HURT': 'Geo Bonus',
        'FIGHT_PROP_GRASS_ADD_HURT': 'Dendro Bonus'
    };
    return propNames[propType] || propType;
}

function getElementIcon(element) {
    const elementIcons = {
        'Pyro': 'https://ik.imagekit.io/gukc1okbd/pyro.png',
        'Hydro': 'https://ik.imagekit.io/gukc1okbd/hydro.png',
        'Electro': 'https://ik.imagekit.io/gukc1okbd/electro.png',
        'Cryo': 'https://ik.imagekit.io/gukc1okbd/cryo.png',
        'Anemo': 'https://ik.imagekit.io/gukc1okbd/anemo.png',
        'Geo': 'https://ik.imagekit.io/gukc1okbd/geo.png',
        'Dendro': 'https://ik.imagekit.io/gukc1okbd/dendro.png'
    };
    return elementIcons[element] || '';
}

function mapElementName(element) {
    const elementMap = {
        'Fire': 'Pyro',
        'Water': 'Hydro',
        'Electric': 'Electro',
        'Ice': 'Cryo',
        'Wind': 'Anemo',
        'Rock': 'Geo',
        'Grass': 'Dendro'
    };
    return elementMap[element] || element;
}

function getWeaponIcon(weaponType) {
    const weaponTypeMap = {
        'WEAPON_SWORD_ONE_HAND': 'Sword',
        'WEAPON_CLAYMORE': 'Claymore',
        'WEAPON_CATALYST': 'Catalyst',
        'WEAPON_BOW': 'Bow',
        'WEAPON_POLEARM': 'Polearm'
    };
    const weaponName = weaponTypeMap[weaponType] || weaponType;
    const weaponIcons = {
        'Sword': 'https://ik.imagekit.io/gukc1okbd/UI_GachaTypeIcon_Sword.png',
        'Claymore': 'https://ik.imagekit.io/gukc1okbd/UI_GachaTypeIcon_Claymore.png',
        'Catalyst': 'https://ik.imagekit.io/gukc1okbd/UI_GachaTypeIcon_Catalyst.png',
        'Bow': 'https://ik.imagekit.io/gukc1okbd/UI_GachaTypeIcon_Bow.png',
        'Polearm': 'https://ik.imagekit.io/gukc1okbd/UI_GachaTypeIcon_Claymore.png'
    };
    return weaponIcons[weaponName] || '';
}

// Material ID to name mapping (common Genshin Impact materials)
const materialNames = {
    '100024': 'Slime Condensate',
    '100025': 'Slime Secretions',
    '100026': 'Slime Concentrate',
    '101010': 'Broken Iron Sword Hilt',
    '101011': 'Bent Iron Sword Hilt',
    '101012': 'Rusted Iron Sword Hilt',
    '104111': 'Ascencion Material 1',
    '104112': 'Ascention Material 2',
    '104113': 'Ascension Material 3',
    '104114': 'Ascension Material 4',
    '112035': 'Material Type 1',
    '112036': 'Material Type 2',
    '112037': 'Material Type 3',
    '113011': 'Local Specialty'
};

function getMaterialName(id) {
    return materialNames[id] || `Material ${id}`;
}

function initLevelButtons(charData) {
    const levelsContainer = document.getElementById('levelButtons');
    const levels = [20, 40, 50, 60, 70, 80, 90];
    
    levelsContainer.innerHTML = '';
    levels.forEach(level => {
        const btn = document.createElement('button');
        btn.className = 'level-btn' + (level === 90 ? ' active' : '');
        btn.textContent = `Lv. ${level}`;
        btn.dataset.level = level;
        btn.addEventListener('click', () => {
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateMaterialCalculator(charData, level);
        });
        levelsContainer.appendChild(btn);
    });
    
    // Initialize with level 90
    updateMaterialCalculator(charData, 90);
}

function calculateMaterialsForLevel(charData, targetLevel) {
    const promotes = charData.upgrade?.promote || [];
    let totalMaterials = {};
    let totalMora = 0;
    
    // Find all promotions needed to reach target level
    for (let i = 1; i < promotes.length; i++) {
        const promo = promotes[i];
        if (!promo.unlockMaxLevel || !promo.costItems) continue;
        
        if (promo.unlockMaxLevel <= targetLevel) {
            // This promotion is needed
            Object.entries(promo.costItems).forEach(([matId, quantity]) => {
                totalMaterials[matId] = (totalMaterials[matId] || 0) + quantity;
            });
            totalMora += promo.coinCost || 0;
        }
    }
    
    return { materials: totalMaterials, mora: totalMora };
}

function calculateStatsAtLevel(charData, targetLevel) {
    const props = charData.upgrade?.prop || [];
    const promotes = charData.upgrade?.promote || [];
    
    let stats = {
        hp: 0,
        atk: 0,
        def: 0
    };
    
    // Get base stats
    props.forEach(prop => {
        if (prop.propType === 'FIGHT_PROP_BASE_HP') stats.hp = prop.initValue;
        if (prop.propType === 'FIGHT_PROP_BASE_ATTACK') stats.atk = prop.initValue;
        if (prop.propType === 'FIGHT_PROP_BASE_DEFENSE') stats.def = prop.initValue;
    });
    
    // Add promoted stats
    for (let i = 1; i < promotes.length; i++) {
        const promo = promotes[i];
        if (!promo.unlockMaxLevel || !promo.addProps) continue;
        
        if (promo.unlockMaxLevel <= targetLevel) {
            const addProps = promo.addProps;
            if (addProps.FIGHT_PROP_BASE_HP) stats.hp += addProps.FIGHT_PROP_BASE_HP;
            if (addProps.FIGHT_PROP_BASE_ATTACK) stats.atk += addProps.FIGHT_PROP_BASE_ATTACK;
            if (addProps.FIGHT_PROP_BASE_DEFENSE) stats.def += addProps.FIGHT_PROP_BASE_DEFENSE;
        }
    }
    
    return stats;
}

// Global inventory cache
let inventoryCache = null;

function loadInventoryData() {
    return fetch('inventory.json')
        .then(r => r.json())
        .then(data => {
            inventoryCache = data;
            return data;
        })
        .catch(err => {
            console.warn('Failed to load inventory.json:', err);
            return null;
        });
}

function calculateTalentUpgradeCosts(talentObj, fromLevel, toLevel) {
    const materials = {};
    let mora = 0;
    
    if (!talentObj || !talentObj.promote) {
        return { materials, mora };
    }
    
    const fromLvl = Math.max(1, Math.min(10, fromLevel));
    const toLvl = Math.max(1, Math.min(10, toLevel));
    
    if (fromLvl >= toLvl) return { materials, mora };
    
    // Iterate through levels and accumulate costs
    for (let level = fromLvl + 1; level <= toLvl; level++) {
        const promote = talentObj.promote[level.toString()];
        if (promote) {
            if (promote.costItems) {
                Object.entries(promote.costItems).forEach(([itemId, qty]) => {
                    materials[itemId] = (materials[itemId] || 0) + qty;
                });
            }
            if (promote.coinCost) {
                mora += promote.coinCost;
            }
        }
    }
    
    return { materials, mora };
}

function initTalentCalculator(charData) {
    if (!charData.talent) {
        document.getElementById('talentsList').innerHTML = '<p style="color:#999;">No talent data available</p>';
        return;
    }
    
    const talent = charData.talent;
    const talentsList = document.getElementById('talentsList');
    
    // Find talents that have promote data (not passives)
    const mainTalentIds = [];
    const talentNames = [];
    const talentTypeNames = ['Normal Attack', 'Elemental Skill', 'Elemental Burst'];
    let typeIndex = 0;
    
    for (let key in talent) {
        const t = talent[key];
        if (t && t.promote && Object.keys(t.promote).length > 0) {
            mainTalentIds.push(parseInt(key));
            talentNames.push(talentTypeNames[typeIndex] || `Talent ${key}`);
            typeIndex++;
            if (mainTalentIds.length >= 3) break;
        }
    }
    
    talentsList.innerHTML = '';
    
    // Create 3 talent cards with icons and level selectors
    mainTalentIds.forEach((talentId, index) => {
        const talentData = talent[talentId];
        const iconUrl = talentData ? `https://gi.yatta.moe/assets/UI/${talentData.icon}.png?vh=2024123000` : '';
        
        const talentCard = document.createElement('div');
        talentCard.style.cssText = `
            background: rgba(255,200,50,0.08);
            border: 1px solid rgba(255,200,50,0.3);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        `;
        
        talentCard.innerHTML = `
            <img src="${iconUrl}" alt="${talentNames[index]}" style="width: 48px; height: 48px; border-radius: 4px; background: rgba(0,0,0,0.3); padding: 4px; box-sizing: border-box;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect fill=%22%23444%22 width=%2248%22 height=%2248%22/%3E%3Ctext fill=%22%23666%22 text-anchor=%22middle%22 x=%2224%22 y=%2730%22%3E?%3C/text%3E%3C/svg%3E'">
            <div style="flex: 1;">
                <div style="font-size: 12px; color: #ffc107; font-weight: 600; text-transform: uppercase;">${talentNames[index]}</div>
                <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                    <label style="font-size: 11px; color: #aaa;">From:</label>
                    <select class="talent-from-level-${talentId}" style="padding: 4px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,200,50,0.2); border-radius: 4px; color: #fff; font-size: 11px;">
                        ${Array.from({length: 10}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                    </select>
                    <label style="font-size: 11px; color: #aaa;">To:</label>
                    <select class="talent-to-level-${talentId}" style="padding: 4px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,200,50,0.2); border-radius: 4px; color: #fff; font-size: 11px;">
                        ${Array.from({length: 10}, (_, i) => `<option value="${i + 1}" ${i + 9 === 10 ? 'selected' : ''}>${i + 1}</option>`).join('')}
                    </select>
                </div>
            </div>
        `;
        
        talentsList.appendChild(talentCard);
    });
    
    // Add single Calculate button below all 3 talents
    const calcButtonDiv = document.createElement('div');
    calcButtonDiv.style.cssText = `
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(255,200,50,0.2);
    `;
    
    calcButtonDiv.innerHTML = `
        <button id="talent-calculate-all" style="flex: 1; padding: 12px 24px; background: linear-gradient(135deg, rgba(255,200,50,0.3) 0%, rgba(255,200,50,0.15) 100%); border: 2px solid rgba(255,200,50,0.5); border-radius: 8px; color: #ffc107; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;">📊 Calculate All Talents</button>
    `;
    
    talentsList.appendChild(calcButtonDiv);
    
    // Add single event listener for the Calculate button
    document.getElementById('talent-calculate-all').addEventListener('click', () => {
        const talentCosts = {};
        let totalMaterials = {};
        let totalMora = 0;
        
        // Get levels for all 3 talents
        mainTalentIds.forEach((talentId) => {
            const fromLevel = parseInt(document.querySelector(`.talent-from-level-${talentId}`).value);
            const toLevel = parseInt(document.querySelector(`.talent-to-level-${talentId}`).value);
            
            if (fromLevel < toLevel) {
                const { materials, mora } = calculateTalentUpgradeCosts(charData.talent[talentId], fromLevel, toLevel);
                talentCosts[talentId] = { materials, mora, fromLevel, toLevel };
                
                // Accumulate materials and mora
                Object.entries(materials).forEach(([itemId, qty]) => {
                    totalMaterials[itemId] = (totalMaterials[itemId] || 0) + qty;
                });
                totalMora += mora;
            }
        });
        
        if (Object.keys(talentCosts).length === 0 || (Object.keys(totalMaterials).length === 0 && totalMora === 0)) {
            document.getElementById('talentCostsDisplay').innerHTML = '<p style="color:#aaa;">Select valid level ranges (From < To) to calculate costs.</p>';
            return;
        }
        
        updateTalentCostsDisplay(totalMaterials, totalMora);
    });
}

function updateTalentCostsDisplay(totalMaterials, totalMora) {
    const displayCosts = (inventory) => {
        let costsHtml = `<div style="border-top: 1px solid rgba(255,200,50,0.2); padding-top: 12px; margin-top: 12px;">
            <div style="font-size: 12px; color: #ffc107; margin-bottom: 12px; font-weight: 600;">📊 Total Cost for All Selected Talents:</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;">`;
        
        // Display materials
        Object.entries(totalMaterials).forEach(([matId, qty]) => {
            const matIdNum = parseInt(matId);
            const invItem = inventory ? inventory.find(item => item.id === matIdNum) : null;
            
            if (invItem) {
                const iconUrl = `https://gi.yatta.moe/assets/UI/${invItem.icon}.png`;
                const rankColor = ['#888', '#4a9eff', '#00d4ff', '#b291dc', '#ffc107'][invItem.rank - 1] || '#888';
                
                costsHtml += `
                    <div class="material-card" data-item-id="${matIdNum}" style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px; background: linear-gradient(135deg, rgba(100,100,255,0.08) 0%, rgba(200,150,255,0.08) 100%); border: 2px solid ${rankColor}; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#ffc107';" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='${rankColor}';">
                        <img src="${iconUrl}" alt="${invItem.name}" style="width: 40px; height: 40px; object-fit: contain;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect fill=%22%23333%22 width=%2240%22 height=%2240%22/%3E%3Ctext fill=%22%23666%22 text-anchor=%22middle%22 x=%2220%22 y=%2725%22 font-size=%2218%22%3E?%3C/text%3E%3C/svg%3E'">
                        <div style="font-size: 11px; color: #7c5cff; font-weight: 700;">${qty}x</div>
                        <div style="font-size: 10px; color: #ddd; line-height: 1.2; word-break: break-word; width: 85px;">${invItem.name}</div>
                    </div>
                `;
            } else {
                costsHtml += `
                    <div class="material-card" data-item-id="${matId}" style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px; background: linear-gradient(135deg, rgba(100,100,100,0.08) 0%, rgba(150,150,150,0.08) 100%); border: 2px solid #666; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#ffc107';" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#666';">
                        <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 24px;">❓</div>
                        <div style="font-size: 11px; color: #7c5cff; font-weight: 700;">${qty}x</div>
                        <div style="font-size: 9px; color: #999;">ID: ${matId}</div>
                    </div>
                `;
            }
        });
        
        // Add mora card
        const moraColor = '#ffd700';
        costsHtml += `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px; background: linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,200,0,0.08) 100%); border: 2px solid ${moraColor}; border-radius: 6px; text-align: center;">
                <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 28px;">💰</div>
                <div style="font-size: 9px; color: ${moraColor}; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Mora</div>
                <div style="font-size: 11px; color: ${moraColor}; font-weight: 700; line-height: 1.2;">${totalMora.toLocaleString()}</div>
            </div>
        `;
        
        costsHtml += '</div></div>';
        document.getElementById('talentCostsDisplay').innerHTML = costsHtml;
        
        // Add click handlers to material cards
        document.querySelectorAll('#talentCostsDisplay .material-card').forEach(card => {
            card.addEventListener('click', () => {
                const itemId = card.dataset.itemId;
                window.location.href = `inventory-item.html?id=${itemId}`;
            });
        });
    };
    
    if (inventoryCache) {
        displayCosts(inventoryCache);
    } else {
        fetch('inventory.json')
            .then(r => r.json())
            .then(inventory => {
                inventoryCache = inventory;
                displayCosts(inventory);
            })
            .catch(err => {
                console.warn('Failed to load inventory:', err);
                displayCosts(null);
            });
    }
}

function updateMaterialCalculator(charData, targetLevel) {
    const { materials, mora } = calculateMaterialsForLevel(charData, targetLevel);
    const stats = calculateStatsAtLevel(charData, targetLevel);
    
    // Display materials with icons
    if (Object.keys(materials).length === 0) {
        document.getElementById('materialsDisplay').innerHTML = '<p style="color:#aaa;">No materials required for this level.</p>';
    } else {
        // Use cached inventory or fetch if not cached
        const displayMaterials = (inventory) => {
            let cardsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-bottom: 16px;">';
            
            // Create material cards
            Object.entries(materials).forEach(([matId, qty]) => {
                const matIdNum = parseInt(matId);
                const invItem = inventory ? inventory.find(item => item.id === matIdNum) : null;
                
                if (invItem) {
                    // Use inventory data with icon
                    const iconUrl = `https://gi.yatta.moe/assets/UI/${invItem.icon}.png`;
                    const rankColor = ['#888', '#4a9eff', '#00d4ff', '#b291dc', '#ffc107'][invItem.rank - 1] || '#888';
                    
                    cardsHtml += `
                        <div class="material-card" data-item-id="${matIdNum}" style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px; background: linear-gradient(135deg, rgba(100,100,255,0.08) 0%, rgba(200,150,255,0.08) 100%); border: 2px solid ${rankColor}; border-radius: 6px; text-align: center; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#ffc107';" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='${rankColor}';">
                            <img src="${iconUrl}" alt="${invItem.name}" style="width: 48px; height: 48px; object-fit: contain;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect fill=%22%23333%22 width=%2248%22 height=%2248%22/%3E%3Ctext fill=%22%23666%22 text-anchor=%22middle%22 x=%2224%22 y=%2730%22 font-size=%2220%22%3E?%3C/text%3E%3C/svg%3E'">
                            <div style="font-size: 12px; color: #7c5cff; font-weight: 700;">${qty}x</div>
                            <div style="font-size: 11px; color: #ddd; line-height: 1.3; word-break: break-word; width: 90px;">${invItem.name}</div>
                        </div>
                    `;
                } else {
                    // Fallback - show material ID
                    cardsHtml += `
                        <div class="material-card" data-item-id="${matIdNum}" style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px; background: linear-gradient(135deg, rgba(100,100,100,0.08) 0%, rgba(150,150,150,0.08) 100%); border: 2px solid #666; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.borderColor='#ffc107';" onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#666';">
                            <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 28px;">❓</div>
                            <div style="font-size: 12px; color: #7c5cff; font-weight: 700;">${qty}x</div>
                            <div style="font-size: 10px; color: #999; line-height: 1.3;">ID: ${matId}</div>
                        </div>
                    `;
                }
            });
            
            // Add mora card
            const moraColor = '#ffd700';
            cardsHtml += `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px; background: linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,200,0,0.08) 100%); border: 2px solid ${moraColor}; border-radius: 6px; text-align: center; transition: all 0.2s;">
                    <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 32px;">💰</div>
                    <div style="font-size: 10px; color: ${moraColor}; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Mora</div>
                    <div style="font-size: 12px; color: ${moraColor}; font-weight: 700; line-height: 1.3;">${mora.toLocaleString()}</div>
                </div>
            `;
            
            cardsHtml += '</div>';
            document.getElementById('materialsDisplay').innerHTML = cardsHtml;
            
            // Add click handlers to material cards
            document.querySelectorAll('.material-card').forEach(card => {
                card.addEventListener('click', () => {
                    const itemId = card.dataset.itemId;
                    window.location.href = `inventory-item.html?id=${itemId}`;
                });
            });
        };
        
        // Use cached inventory or fetch
        if (inventoryCache) {
            displayMaterials(inventoryCache);
        } else {
            fetch('inventory.json')
                .then(r => r.json())
                .then(inventory => {
                    inventoryCache = inventory;
                    displayMaterials(inventory);
                })
                .catch(err => {
                    console.warn('Failed to load inventory:', err);
                    displayMaterials(null);
                });
        }
    }
    
    // Update stats display
    document.getElementById('statHP').textContent = Math.round(stats.hp);
    document.getElementById('statATK').textContent = Math.round(stats.atk);
    document.getElementById('statDEF').textContent = Math.round(stats.def);
}

function initDetailPage() {
    // tabs
    document.querySelectorAll('.detail-tabs a').forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.dataset.tab;
            document.querySelectorAll('.detail-tabs a').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('[id^="tab-"]').forEach(sec => sec.style.display = 'none');
            const section = document.getElementById('tab-' + target);
            if (section) section.style.display = 'block';
        });
    });
}

document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
